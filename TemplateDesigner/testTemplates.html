<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>Article Rendering</title>

   <style type="text/css">
    .container {
        width:400px;
        clear: both;
   	}
    .container label {
        display:block;
        font-weight:bold;
        width:140px;
        float:left;
        margin-top:5px;
    }
    .container input, .container select {
        float:left;
        font-size:12px;
        padding:4px 2px;
        border:solid 1px #aacfe4;
        width:200px;
        margin:2px 0 10px 10px;
    }
    .container input[type="checkbox"] {
        margin-top:6px;
    }
    #runTemplate, #savePage, #loadPage {
        clear: both;
        font-size:12px;
        border:solid 1px #aacfe4;
        width:100px;
        margin:10px 0px 10px 0px;
    }
    .spacer{clear:both; height:1px;}

    </style>

	<script type="text/javascript" src="lib/jq.mobi.js"></script>
	<script type="text/javascript" src="lib/jsrender-1.0.js"></script>
	<script type="text/javascript" src="src/articleRenderer.js"></script>
	<script type="text/javascript" src="src/template.js"></script>
	<script type="text/javascript" src="testSpecs/sampleArticles.js"></script>
	<script type="text/javascript" src="testSpecs/sampleTemplates.js"></script>

	<script type="text/javascript">

	'use strict'
	window.onload = function() {
		// Load the articles
		var articleList = $("#articleList");
		$(sampleArticles).each(function() {
			var option = '<option value="' + this.name + '">' + this.name + '</option>';
			articleList.append(option);
		})

		// Load the templates
		var templateList = $("#templateList");
		$(sampleTemplates).each(function() {
			var option = '<option value="' + this.name + '">' + this.name + '</option>';
			templateList.append(option);
		})

		// Add click handlers
		$("#runTemplate").click(function() { runTemplate(); });
		$("#savePage").click(function() { savePage(); });
		$("#loadPage").click(function() { loadPage(); });
	};

	function runTemplate() {
		// Get the current article.
		var articleName = $("#articleList").val();
		var article = findItemNamed(articleName, sampleArticles);
		if (article == null) {
			alert("Invalid article");
			return;
		}

		// Get the current template.
		var templateName = $("#templateList").val();
		var template = findItemNamed(templateName, sampleTemplates);
		if (template == null) {
			alert("Invalid template");
			return;
		}

		// Get the orientation.
		var orientationName = $("#orientationList").val();
		var orientation = null;
		if (orientationName == "portrait" || orientationName == "landscape")
			orientation = { "orientation":orientationName };

		// Run the template
		var result = renderPage(template.definition, article.definition, orientation);

		// Format the output.
		var format = $("#format").is(':checked');
		if (format) {
			result = result.replace(/<(\/?)[a-zA-Z]+(?:[^>"']+|"[^"]*"|'[^']*')*>/g, function($0, $1) {
			    return $1 === "/" ? $0+"\n" : "\n"+$0;
			});
		}
		$("#htmlOutput").html(result);
	}

	function findItemNamed(name, list) {
		var length = list.length;
		for (var i = 0; i < length; i ++) {
			if (list[i].name == name)
				return list[i];
		}
		return null;
	};

	function renderPage(template, article, orientation) {
		console.time("renderPage");
		var renderer = new ds.ArticleRenderer();
		var actualOutput = renderer.renderPage(template, article, orientation);
		console.timeEnd("renderPage");
		return actualOutput;
	};

	function savePage() {
		var uriContent = "data:application/octet-stream," + encodeURIComponent($("#htmlOutput").val());
		window.open(uriContent, 'Save');		
	}

	function loadPage() {
		console.time("loadPage");
		document.documentElement.innerHTML = $("#htmlOutput").val();
		console.timeEnd("loadPage");
	}

</script>

</head>
<body>
	<h1>Article Rendering</h1>
	<div class="container">
	<form>
   		<label>Article Input</label>
		<select id="articleList" name="article">
			<!-- <option value="volvo">Volvo</option> -->
		</select>
   		<label>Template Type</label>
		<select id="templateList" name="template">
			<!-- <option value="volvo">Volvo</option> -->
		</select>
   		<label>Orientation</label>
		<select id="orientationList" name="orientation">
			<option value="portrait">Portrait</option>
			<option value="landscape">Landscape</option>
			<option value="undefined">Undefined</option>
		</select>
   		<label>Format the output </label>
		<input id="format" type="checkbox" checked="checked" name="format">
	    <div class="spacer"></div>
	</form>
	</div>
	<form>
		<input id="runTemplate" type="button" value="Run Template">
		<input id="savePage" type="button" value="Save">
		<input id="loadPage" type="button" value="Load">
	</form>
	<textarea id="htmlOutput" class="code" wrap="logical" style="height: 300px; width: 600px; ">
	</textarea>
</body>
</html>
